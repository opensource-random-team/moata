<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/layout}">
<th:block layout:fragment="content">
    <head>
        <meta charset="UTF-8">
        <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=40e93d960060fff7cf23e2b43dfcc0e2&libraries=services"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Moata-매칭</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="/css/global.css">
    </head>
    <body class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-indigo-50">
        <div class="fixed inset-0 overflow-hidden pointer-events-none">
            <div class="absolute -top-40 -right-40 w-80 h-80 bg-blue-200/30 rounded-full blur-3xl"></div>
            <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-indigo-200/30 rounded-full blur-3xl"></div>
        </div>

        <div class="container mx-auto px-4 py-8 relative z-10">
            <div class="max-w-4xl mx-auto">
                <!-- Search Form -->
                <div class="mb-8 shadow-lg border-0 bg-white/80 backdrop-blur-sm rounded-lg p-6">
                    <h2 class="text-2xl font-semibold mb-6 flex items-center gap-2">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                        택시 메이트 찾기
                    </h2>

                    <p class="mb-4 text-sm text-gray-600 flex items-center">
                        <svg class="w-4 h-4 mr-1 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                        <span id="location-status-text">내 위치 상태: 위치를 찾는 중...</span>
                    </p>

                    <form id="searchForm" class="space-y-6">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-medium block mb-2">출발지</label>
                                <input id="departure" type="text" placeholder="출발지를 입력하세요" class="w-full px-3 py-2 border rounded-lg pl-10">
                            </div>
                            <div>
                                <label class="text-sm font-medium block mb-2">목적지</label>
                                <input id="destination" type="text" placeholder="목적지를 입력하세요" class="w-full px-3 py-2 border rounded-lg pl-10">
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 text-lg rounded-lg">
                            택시 메이트 찾기
                        </button>
                    </form>
                </div>

                <!-- Results -->
                <div id="results" class="hidden space-y-6">
                    <div class="flex items-center justify-between">
                        <h2 class="text-2xl font-bold text-gray-900">매칭 결과</h2>
                    </div>

                    <!-- Match Cards will be injected here -->
                    <div id="matchCards" class="space-y-4"></div>
                </div>
            </div>
        </div>

        <script src="/js/app.js"></script>
        <script>
            let myCurrentLat = null;
            let myCurrentLon = null;

            function updateLocationStatus(msg) {
                const statusEl = document.getElementById('location-status-text');
                if (statusEl) statusEl.textContent = msg;
            }

            function sendLocationToServer(lat, lon) {
                fetch("/user/location", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: `lat=${lat.toFixed(7)}&lon=${lon.toFixed(7)}`
                }).then(res => res.text())
                  .then(res => console.log("위치 전송 결과:", res));
            }

            function getNearbyUsers(lat, lon, radiusKm = 3) {
                fetch(`/user/nearby?lat=${lat.toFixed(7)}&lon=${lon.toFixed(7)}&radius=${radiusKm}`)
                    .then(res => res.json())
                    .then(users => {
                        const matchCards = document.getElementById("matchCards");
                        matchCards.innerHTML = "";
                        if (!users || users.length === 0) {
                            updateLocationStatus("근처 사용자를 찾지 못했습니다.");
                            return;
                        }
                        document.getElementById("results").classList.remove('hidden');
                        users.forEach(u => {
                            const card = document.createElement("div");
                            card.className = "bg-white/80 backdrop-blur-sm rounded-lg p-6 hover:shadow-lg transition";
                            card.innerHTML = `
                                <div class="flex items-start justify-between">
                                    <div class="flex items-start gap-4 flex-1">
                                        <div class="relative">
                                            <div class="w-12 h-12 bg-blue-500 rounded-full"></div>
                                        </div>
                                        <div class="flex-1 space-y-3">
                                            <div class="flex items-center gap-3">
                                                <h3 class="font-semibold text-lg">${u.username}</h3>
                                            </div>
                                            <div class="grid md:grid-cols-2 gap-3 text-sm text-gray-600">
                                                <div>출발: ${u.departure || '-'}</div>
                                                <div>도착: ${u.destination || '-'}</div>
                                                <div>거리: ${u.distance.toFixed(3)} km</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex flex-col gap-2 ml-4">
                                        <a href="/chat?target=${u.userId}">
                                            <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                                                채팅하기
                                            </button>
                                        </a>
                                    </div>
                                </div>
                            `;
                            matchCards.appendChild(card);
                        });
                    });
            }

			function initLocation() {
			    if (!navigator.geolocation) {
			        updateLocationStatus("Geolocation API를 지원하지 않습니다.");
			        return;
			    }

			    navigator.geolocation.getCurrentPosition(function(position) {
			        const lat = position.coords.latitude;
			        const lon = position.coords.longitude;

			        myCurrentLat = lat;
			        myCurrentLon = lon;

			        updateLocationStatus(`위치 확인 완료`);

			        // 서버에 현재 위치 저장
			        sendLocationToServer(lat, lon);

			        // 여기서 getNearbyUsers()를 호출하지 않음!!
			        // -> 검색 버튼 눌러야만 결과 보여줌

			    }, function(err) {
			        updateLocationStatus(`위치 가져오기 실패: ${err.message}`);
			    }, {
			        enableHighAccuracy: true,
			        timeout: 10000,
			        maximumAge: 0
			    });
			}

			searchForm.addEventListener('submit', (e) => {
			    e.preventDefault();

			    const departure = document.getElementById('departure').value;
			    const destination = document.getElementById('destination').value;

			    if (!departure || !destination) {
			        alert('출발지와 목적지를 입력해주세요.');
			        return;
			    }

			    if (!myCurrentLat || !myCurrentLon) {
			        alert('현재 위치를 확인 중입니다.');
			        return;
			    }

			    // 서버에 출발/도착 저장
			    fetch(`/user/setRoute?lat=${myCurrentLat}&lon=${myCurrentLon}&departure=${encodeURIComponent(departure)}&destination=${encodeURIComponent(destination)}`, {
			        method: 'POST'
			    })
			    .then(res => res.text())
			    .then(res => {
			        console.log("출발/도착지 저장 결과:", res);

			        // 저장 후 매칭 사용자 검색
			        getNearbyUsers(myCurrentLat, myCurrentLon);
			    });
			});

			initLocation();

        </script>
    </body>
</th:block>
</html>
